<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:;">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kids Coloring Master - Responsive</title>
    <style>
        /* --- CSS ä½ˆå±€æ ¸å¿ƒ --- */
        body {
            margin: 0;
            overflow: hidden; /* å¾¹åº•ç¦æ­¢æ²å‹• */
            background-color: #f0f4f8;
            font-family: "Varela Round", sans-serif;
            display: flex;
            flex-direction: column; /* å‚ç›´æ’åˆ— */
            height: 100vh; /* ä½”æ»¿è¦–çª—é«˜åº¦ */
            height: 100dvh; /* é‡å°ç§»å‹•ç€è¦½å™¨å‹•æ…‹é«˜åº¦çš„å„ªåŒ– */
            overscroll-behavior: none;
            user-select: none;
        }

        /* é ‚éƒ¨å·¥å…·åˆ—ï¼šå›ºå®šé«˜åº¦ï¼Œä¸å¯å£“ç¸® */
        #toolbar {
            height: 60px;
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            z-index: 10;
            flex-shrink: 0; /* é—œéµï¼šç¦æ­¢è¢«å£“ç¸® */
        }

        /* ç•«å¸ƒå®¹å™¨ï¼šä½”æ»¿å‰©é¤˜ç©ºé–“ï¼Œä½†çµ•ä¸æº¢å‡º */
        #canvas-container {
            flex: 1; /* åƒæ‰æ‰€æœ‰å‰©é¤˜ç©ºé–“ */
            min-height: 0; /* ğŸ† é—œéµä¿®æ­£ï¼šå…è¨±å®¹å™¨ç¸®å°åˆ°æ¯”å…§å®¹é‚„å° */
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            background: #eef2f5; /* å®¹å™¨åº•è‰²èˆ‡èƒŒæ™¯ä¸€è‡´ï¼Œè®“ç•«å¸ƒåƒæµ®åœ¨ä¸­é–“ */
            padding: 10px; /* ç•™ä¸€é»é‚Šè· */
            width: 100%;
            box-sizing: border-box;
        }

        canvas {
            /* è®“ Canvas è‡ªå·±æ±ºå®šå¤§å°ï¼Œä½†çµ•å°ä¸è¶…éå®¹å™¨ */
            max-width: 100%;
            max-height: 100%;
            object-fit: contain; /* ä¿æŒæ¯”ä¾‹ */
            background: white; /* ç•«å¸ƒæœ¬é«”æ˜¯ç™½çš„ */
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); /* çµ¦ç•«å¸ƒåŠ é™°å½± */
            border-radius: 8px;
            touch-action: none;
            cursor: crosshair;
        }

        /* åº•éƒ¨è‰²ç¥¨ï¼šå›ºå®šé«˜åº¦ï¼Œä¸å¯å£“ç¸® */
        #palette {
            height: 90px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            background: #fff;
            padding-bottom: env(safe-area-inset-bottom);
            box-shadow: 0 -4px 10px rgba(0,0,0,0.05);
            flex-shrink: 0; /* é—œéµï¼šç¦æ­¢è¢«å£“ç¸® */
            overflow-x: auto; /* å¦‚æœé¡è‰²å¤ªå¤šï¼Œå…è¨±å·¦å³æ»‘å‹• */
        }

        /* æŒ‰éˆ•æ¨£å¼å„ªåŒ– */
        .btn {
            background: #eef2f5;
            border: none;
            border-radius: 12px;
            width: 40px;
            height: 40px;
            font-size: 18px;
            cursor: pointer;
            display: flex; justify-content: center; align-items: center;
            transition: all 0.1s;
        }
        .btn:active { transform: scale(0.9); background: #dce4e8; }
        .btn:disabled { opacity: 0.3; cursor: not-allowed; transform: none; }
        .btn-save { background: #4CD964; color: white; width: auto; padding: 0 15px; font-weight: bold; font-size: 14px; }
        .tool-group { display: flex; gap: 10px; }

        .color-swatch {
            width: 40px;
            height: 40px;
            min-width: 40px; /* é˜²æ­¢è¢«æ“ æ‰ */
            border-radius: 50%;
            border: 3px solid #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }
        .color-swatch.active { transform: scale(1.2); border-color: #333; }

        /* é‡å° PC çš„é¡å¤–å„ªåŒ–ï¼šç•¶è¢å¹•å¤ å¯¬æ™‚ï¼Œå¢åŠ ä¸€äº›é™°å½±å±¤æ¬¡ */
        @media (min-width: 768px) {
            #canvas-container { padding: 20px; }
        }
    </style>
</head>
<body>

    <div id="toolbar">
        <div class="tool-group">
            <button id="btn-undo" class="btn" title="å¾©åŸ">â†©ï¸</button>
            <button id="btn-redo" class="btn" title="é‡åš">â†ªï¸</button>
        </div>
        <button id="btn-save" class="btn btn-save" title="å„²å­˜åœ–ç‰‡">ğŸ’¾ å„²å­˜</button>
    </div>

    <div id="canvas-container">
        <canvas id="drawing-canvas"></canvas>
    </div>

    <div id="palette"></div>

    <script>
        // --- åƒæ•¸è¨­å®š ---
        const IMAGE_FILENAME = 'coloring.png'; // âš ï¸ è«‹ç¢ºèªæª”å
        const TOLERANCE = 50; 
        const MAX_HISTORY = 10; 

        // --- DOM ---
        const canvas = document.getElementById('drawing-canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const paletteContainer = document.getElementById('palette');
        const btnUndo = document.getElementById('btn-undo');
        const btnRedo = document.getElementById('btn-redo');
        const btnSave = document.getElementById('btn-save');
        
        // --- ç‹€æ…‹ ---
        let currentColor = [255, 59, 48, 255]; 
        const baseWidth = 800;
        const baseHeight = 800; // å…§éƒ¨è§£æåº¦ç¶­æŒæ­£æ–¹å½¢ï¼Œé¡¯ç¤ºç”± CSS æ§åˆ¶
        
        let historyStack = [];
        let redoStack = [];

        function init() {
            // è¨­å®šç•«å¸ƒå…§éƒ¨è§£æåº¦ (é€™è·Ÿè¢å¹•é¡¯ç¤ºå¤§å°ç„¡é—œï¼Œæ˜¯ç…§ç‰‡çš„è§£æåº¦)
            canvas.width = baseWidth;
            canvas.height = baseHeight;
            
            createPalette();
            loadLineArt();
            updateUI();

            canvas.addEventListener('pointerdown', handleCanvasClick);
            btnUndo.addEventListener('click', undo);
            btnRedo.addEventListener('click', redo);
            btnSave.addEventListener('click', saveImage);

            // ğŸ‘‡ æ–°å¢ï¼šç›£è½è¦–çª—æ”¹è®Šï¼Œç¢ºä¿ç•«å¸ƒæ°¸é åœ¨æ­£ç¢ºä½ç½® (é›–ç„¶ CSS å·²ç¶“è™•ç†å¤§éƒ¨åˆ†)
            window.addEventListener('resize', () => {
                // é€™è£¡å¯ä»¥åŠ å…¥é‡æ–°è¨ˆç®—é‚è¼¯ï¼Œä½†ç›®å‰çš„ CSS æ–¹æ¡ˆå·²ç¶“èƒ½è‡ªå‹•è™•ç†
                // å¦‚æœéœ€è¦ç‰¹æ®Šé‡ç¹ªå¯ä»¥åœ¨é€™è£¡åŠ 
            });
        }

        // --- è¼‰å…¥èˆ‡ç¹ªåœ– ---
        function loadLineArt() {
            const img = new Image();
            img.crossOrigin = "Anonymous";
            img.src = IMAGE_FILENAME;

            img.onload = function() {
                // 1. å¡—ç™½åº•
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // 2. æ™ºæ…§ç¸®æ”¾ (å³ä½¿åœ–ç‰‡ä¸æ˜¯æ­£æ–¹å½¢ï¼Œä¹Ÿæœƒè‡ªå‹•é©é…åˆ° 800x800 å…§)
                const scale = Math.min(canvas.width / img.width, canvas.height / img.height);
                const w = img.width * scale;
                const h = img.height * scale;
                const x = (canvas.width - w) / 2;
                const y = (canvas.height - h) / 2;

                ctx.drawImage(img, x, y, w, h);
                // åˆå§‹ç‹€æ…‹ä¸ä¸€å®šè¦å­˜å…¥ historyï¼Œè¦–éœ€æ±‚è€Œå®š
            };
            
            img.onerror = function() {
                // é€™è£¡ä¸è·³ alert æ“¾äººï¼Œæ”¹ç”¨ console
                console.error("æ‰¾ä¸åˆ°åœ–ç‰‡ï¼Œè«‹æª¢æŸ¥æª”å");
            };
        }

        // --- åº§æ¨™è½‰æ›ç³»çµ± (å›æ‡‰å¼æ ¸å¿ƒ) ---
        function handleCanvasClick(e) {
            // æ¯æ¬¡é»æ“Šéƒ½é‡æ–°è¨ˆç®—ï¼Œä¿è­‰è¦–çª—ç¸®æ”¾å¾Œä¾ç„¶æº–ç¢º
            const rect = canvas.getBoundingClientRect();
            
            // ç®—å‡º Canvas å…§éƒ¨åƒç´  èˆ‡ è¢å¹•é¡¯ç¤ºåƒç´  çš„æ¯”ä¾‹
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;

            const x = Math.floor((e.clientX - rect.left) * scaleX);
            const y = Math.floor((e.clientY - rect.top) * scaleY);

            floodFill(x, y, currentColor);
        }

        // --- è‘—è‰²é‚è¼¯ (èˆ‡ä¹‹å‰ç›¸åŒ) ---
        function floodFill(startX, startY, fillColor) {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const pixels = imageData.data;
            
            const startPos = (startY * canvas.width + startX) * 4;
            const startR = pixels[startPos];
            const startG = pixels[startPos + 1];
            const startB = pixels[startPos + 2];

            if (colorsAreSimilar(startR, startG, startB, fillColor[0], fillColor[1], fillColor[2], 20) || 
                isBlackOutline(startR, startG, startB)) {
                return;
            }

            saveState(); // å­˜æª”

            const queue = [[startX, startY]];
            const visited = new Uint8Array(canvas.width * canvas.height); 
            
            while (queue.length > 0) {
                const [x, y] = queue.shift();
                const pixelIndex = y * canvas.width + x;
                
                if (visited[pixelIndex]) continue;
                visited[pixelIndex] = 1;

                const pixelPos = pixelIndex * 4;
                const r = pixels[pixelPos];
                const g = pixels[pixelPos + 1];
                const b = pixels[pixelPos + 2];

                if (colorsAreSimilar(r, g, b, startR, startG, startB, TOLERANCE)) {
                    pixels[pixelPos] = fillColor[0];
                    pixels[pixelPos + 1] = fillColor[1];
                    pixels[pixelPos + 2] = fillColor[2];
                    pixels[pixelPos + 3] = 255; 

                    if (x > 0) queue.push([x - 1, y]);
                    if (x < canvas.width - 1) queue.push([x + 1, y]);
                    if (y > 0) queue.push([x, y - 1]);
                    if (y < canvas.height - 1) queue.push([x, y + 1]);
                }
            }
            ctx.putImageData(imageData, 0, 0);
        }

        // --- Undo/Redo ç³»çµ± ---
        function saveState() {
            redoStack = []; 
            if (historyStack.length >= MAX_HISTORY) historyStack.shift();
            historyStack.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
            updateUI();
        }

        function undo() {
            if (historyStack.length === 0) return;
            redoStack.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
            const previousState = historyStack.pop();
            ctx.putImageData(previousState, 0, 0);
            updateUI();
        }

        function redo() {
            if (redoStack.length === 0) return;
            historyStack.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
            const nextState = redoStack.pop();
            ctx.putImageData(nextState, 0, 0);
            updateUI();
        }

        function updateUI() {
            btnUndo.disabled = historyStack.length === 0;
            btnRedo.disabled = redoStack.length === 0;
        }

        // --- å„²å­˜èˆ‡è¼”åŠ© ---
        function saveImage() {
            const link = document.createElement('a');
            const date = new Date();
            const timestamp = `${date.getFullYear()}${date.getMonth()+1}${date.getDate()}_${date.getHours()}${date.getMinutes()}`;
            link.download = `KidsArt_${timestamp}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        function colorsAreSimilar(r1, g1, b1, r2, g2, b2, tol) {
            return (Math.abs(r1 - r2) + Math.abs(g1 - g2) + Math.abs(b1 - b2)) <= tol;
        }

        function isBlackOutline(r, g, b) {
            return r < 100 && g < 100 && b < 100; 
        }

        function createPalette() {
            const colors = [
                [255, 59, 48], [255, 149, 0], [255, 204, 0], [76, 217, 100],
                [90, 200, 250], [0, 122, 255], [88, 86, 214], [255, 105, 180], 
                [100, 100, 100], [255, 255, 255]
            ];
            colors.forEach((c, index) => {
                const div = document.createElement('div');
                div.className = `color-swatch ${index === 0 ? 'active' : ''}`;
                div.style.backgroundColor = `rgb(${c[0]},${c[1]},${c[2]})`;
                div.addEventListener('click', () => {
                    document.querySelectorAll('.color-swatch').forEach(el => el.classList.remove('active'));
                    div.classList.add('active');
                    currentColor = [...c, 255];
                });
                paletteContainer.appendChild(div);
            });
        }

        init();
    </script>
</body>
</html>