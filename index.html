<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:;">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kids Coloring Master - Final Fix</title>
    <style>
        /* --- CSS ä½ˆå±€æ ¸å¿ƒ --- */
        body {
            margin: 0;
            overflow: hidden;
            background-color: #f0f4f8;
            font-family: "Varela Round", sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
            overscroll-behavior: none;
            user-select: none;
        }

        #toolbar {
            height: 8vh;
            min-height: 50px;
            max-height: 70px;
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            z-index: 10;
            flex-shrink: 0;
        }

        #canvas-container {
            flex: 1;
            min-height: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            background: #eef2f5;
            padding: 10px;
            width: 100%;
            box-sizing: border-box;
        }

        canvas {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            background: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-radius: 8px;
            touch-action: none;
            cursor: crosshair;
        }

        /* --- è‰²ç¥¨å€ --- */
        #palette {
            height: 12vh;
            min-height: 70px;
            max-height: 120px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 1.5vh;
            background: #fff;
            padding: 0 15px;
            padding-bottom: env(safe-area-inset-bottom);
            box-shadow: 0 -4px 10px rgba(0,0,0,0.05);
            flex-shrink: 0;
            overflow-x: auto; 
            overflow-y: hidden;
            scrollbar-width: thin; 
            scrollbar-color: #ddd transparent;
        }

        #palette::-webkit-scrollbar { height: 6px; }
        #palette::-webkit-scrollbar-thumb { background-color: #ddd; border-radius: 10px; }
        #palette::-webkit-scrollbar-track { background: transparent; }

        @media (pointer: coarse) {
            #palette { scrollbar-width: none; }
            #palette::-webkit-scrollbar { display: none; }
        }

        .color-swatch {
            height: 65%;
            aspect-ratio: 1 / 1;
            border-radius: 50%;
            border: 3px solid #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: transform 0.1s;
            flex-shrink: 0;
        }
        .color-swatch.active { transform: scale(1.15); border-color: #333; }

        .btn {
            background: #eef2f5;
            border: none;
            border-radius: 12px;
            height: 70%;
            aspect-ratio: 1/1;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex; justify-content: center; align-items: center;
        }
        .btn:active { transform: scale(0.9); background: #dce4e8; }
        .btn:disabled { opacity: 0.3; cursor: not-allowed; transform: none; }
        .btn-save { background: #4CD964; color: white; width: auto; aspect-ratio: auto; padding: 0 20px; font-weight: bold; font-size: 1rem; }
        .tool-group { display: flex; gap: 10px; height: 100%; align-items: center; }

        @media (min-width: 768px) {
            #canvas-container { padding: 20px; }
        }
    </style>
</head>
<body>

    <div id="toolbar">
        <div class="tool-group">
            <button id="btn-undo" class="btn" title="å¾©åŸ">â†©ï¸</button>
            <button id="btn-redo" class="btn" title="é‡åš">â†ªï¸</button>
        </div>
        <button id="btn-save" class="btn btn-save" title="å„²å­˜åœ–ç‰‡">ğŸ’¾ å„²å­˜</button>
    </div>

    <div id="canvas-container">
        <canvas id="drawing-canvas"></canvas>
    </div>

    <div id="palette"></div>

    <script>
        // --- åƒæ•¸è¨­å®š ---
        const IMAGE_FILENAME = 'coloring.png'; 
        const TOLERANCE = 50; 
        const MAX_HISTORY = 10; 
        // ğŸ† ä¿®æ­£é» 1: èª¿é™ç·šæ¢åˆ¤æ–·é–€æª» (åŸæœ¬ 100 -> æ”¹ç‚º 50)
        // åªæœ‰éå¸¸é»‘çš„é¡è‰² (RGB < 50) æ‰æœƒè¢«ç•¶ä½œã€Œä¸å¯è¦†è“‹çš„ç·šæ¢ã€
        const LINE_THRESHOLD = 50; 

        // --- DOM ---
        const canvas = document.getElementById('drawing-canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const paletteContainer = document.getElementById('palette');
        const btnUndo = document.getElementById('btn-undo');
        const btnRedo = document.getElementById('btn-redo');
        const btnSave = document.getElementById('btn-save');
        
        let currentColor = [255, 59, 48, 255]; 
        const baseWidth = 800;
        const baseHeight = 800; 
        
        let historyStack = [];
        let redoStack = [];

        function init() {
            canvas.width = baseWidth;
            canvas.height = baseHeight;
            
            createPalette();
            loadLineArt();
            updateUI();

            canvas.addEventListener('pointerdown', handleCanvasClick);
            btnUndo.addEventListener('click', undo);
            btnRedo.addEventListener('click', redo);
            btnSave.addEventListener('click', saveImage);

            paletteContainer.addEventListener('wheel', (e) => {
                if (e.deltaY !== 0) {
                    e.preventDefault();
                    paletteContainer.scrollLeft += e.deltaY;
                }
            }, { passive: false });
        }

        function createPalette() {
            const colors = [
                // ç´…ç²‰è‰²ç³»
                [255, 59, 48], [255, 105, 180], [255, 182, 193], [220, 20, 60],
                // æ©™é»ƒè‰²ç³»
                [255, 149, 0], [255, 165, 0], [255, 204, 0], [255, 255, 0], [240, 230, 140],
                // è†šè‰²èˆ‡å¤§åœ°è‰²
                [255, 228, 196], [255, 218, 185], [210, 180, 140], [139, 69, 19],
                // ç¶ è‰²ç³»
                [76, 217, 100], [124, 252, 0], [34, 139, 34], [0, 128, 128],
                // è—è‰²ç³»
                [90, 200, 250], [0, 191, 255], [0, 122, 255], [0, 0, 139],
                // ç´«è‰²ç³»
                [88, 86, 214], [148, 0, 211], [221, 160, 221],
                // é»‘ç™½ç° (ğŸ† ä¿®æ­£é» 2: èª¿æ•´æ·±è‰²ç³»çš„ RGB å€¼ï¼Œç¢ºä¿å®ƒå€‘ > 50)
                [255, 255, 255], // ç™½
                [211, 211, 211], // æ·ºç°
                [150, 150, 150], // ä¸­ç° (èª¿äº®)
                [105, 105, 105], // æ·±ç° (åŸæœ¬æ˜¯ 80 -> æ”¹ 105ï¼Œå¤§æ–¼ LINE_THRESHOLD)
                [60, 60, 60],    // é»‘ç° (åŸæœ¬æ˜¯ 0 -> æ”¹ 60ï¼Œçœ‹èµ·ä¾†åƒé»‘ï¼Œä½†ç¨‹å¼èªå®šæ˜¯é¡æ–™)
                [55, 55, 55]     // æ¨¡æ“¬ç´”é»‘ (Human Black)ï¼Œæ•¸å€¼å¤ å¤§å¯è¢«é‡å¡—
            ];

            colors.forEach((c, index) => {
                const div = document.createElement('div');
                div.className = `color-swatch ${index === 0 ? 'active' : ''}`;
                div.style.backgroundColor = `rgb(${c[0]},${c[1]},${c[2]})`;
                div.addEventListener('click', () => {
                    document.querySelectorAll('.color-swatch').forEach(el => el.classList.remove('active'));
                    div.classList.add('active');
                    currentColor = [...c, 255];
                });
                paletteContainer.appendChild(div);
            });
        }

        // --- æ ¸å¿ƒé‚è¼¯ ---
        function loadLineArt() {
            const img = new Image();
            img.crossOrigin = "Anonymous";
            img.src = IMAGE_FILENAME;
            img.onload = function() {
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                const scale = Math.min(canvas.width / img.width, canvas.height / img.height);
                const w = img.width * scale;
                const h = img.height * scale;
                const x = (canvas.width - w) / 2;
                const y = (canvas.height - h) / 2;
                ctx.drawImage(img, x, y, w, h);
            };
            img.onerror = function() { console.error("æ‰¾ä¸åˆ°åœ–ç‰‡"); };
        }

        function handleCanvasClick(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = Math.floor((e.clientX - rect.left) * scaleX);
            const y = Math.floor((e.clientY - rect.top) * scaleY);
            floodFill(x, y, currentColor);
        }

        function floodFill(startX, startY, fillColor) {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const pixels = imageData.data;
            const startPos = (startY * canvas.width + startX) * 4;
            const startR = pixels[startPos];
            const startG = pixels[startPos + 1];
            const startB = pixels[startPos + 2];

            // æª¢æŸ¥ï¼šå¦‚æœé»æ“Šçš„é¡è‰²ç›¸ä¼¼åº¦å¤ªé«˜ (é¿å…é‡è¤‡å¡«è‰²)
            if (colorsAreSimilar(startR, startG, startB, fillColor[0], fillColor[1], fillColor[2], 20)) return;
            
            // æª¢æŸ¥ï¼šå¦‚æœé»æ“Šçš„æ˜¯ã€ŒçœŸæ­£çš„ç·šæ¢ã€ (RGB < 50)ï¼Œå‰‡ç¦æ­¢å¡«è‰²
            if (isBlackOutline(startR, startG, startB)) return;

            saveState();

            const queue = [[startX, startY]];
            const visited = new Uint8Array(canvas.width * canvas.height); 
            
            while (queue.length > 0) {
                const [x, y] = queue.shift();
                const pixelIndex = y * canvas.width + x;
                if (visited[pixelIndex]) continue;
                visited[pixelIndex] = 1;

                const pixelPos = pixelIndex * 4;
                const r = pixels[pixelPos];
                const g = pixels[pixelPos + 1];
                const b = pixels[pixelPos + 2];

                if (colorsAreSimilar(r, g, b, startR, startG, startB, TOLERANCE)) {
                    pixels[pixelPos] = fillColor[0];
                    pixels[pixelPos + 1] = fillColor[1];
                    pixels[pixelPos + 2] = fillColor[2];
                    pixels[pixelPos + 3] = 255; 
                    if (x > 0) queue.push([x - 1, y]);
                    if (x < canvas.width - 1) queue.push([x + 1, y]);
                    if (y > 0) queue.push([x, y - 1]);
                    if (y < canvas.height - 1) queue.push([x, y + 1]);
                }
            }
            ctx.putImageData(imageData, 0, 0);
        }

        function saveState() {
            redoStack = []; 
            if (historyStack.length >= MAX_HISTORY) historyStack.shift();
            historyStack.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
            updateUI();
        }

        function undo() {
            if (historyStack.length === 0) return;
            redoStack.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
            const previousState = historyStack.pop();
            ctx.putImageData(previousState, 0, 0);
            updateUI();
        }

        function redo() {
            if (redoStack.length === 0) return;
            historyStack.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
            const nextState = redoStack.pop();
            ctx.putImageData(nextState, 0, 0);
            updateUI();
        }

        function updateUI() {
            btnUndo.disabled = historyStack.length === 0;
            btnRedo.disabled = redoStack.length === 0;
        }

        function saveImage() {
            const link = document.createElement('a');
            const date = new Date();
            const timestamp = `${date.getFullYear()}${date.getMonth()+1}${date.getDate()}_${date.getHours()}${date.getMinutes()}`;
            link.download = `KidsArt_${timestamp}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        function colorsAreSimilar(r1, g1, b1, r2, g2, b2, tol) {
            return (Math.abs(r1 - r2) + Math.abs(g1 - g2) + Math.abs(b1 - b2)) <= tol;
        }

        // ğŸ† ä¿®æ­£é» 3: ä½¿ç”¨å…¨åŸŸè®Šæ•¸ LINE_THRESHOLD
        function isBlackOutline(r, g, b) {
            return r < LINE_THRESHOLD && g < LINE_THRESHOLD && b < LINE_THRESHOLD; 
        }

        init();
    </script>
</body>
</html>