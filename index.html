<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:;">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kids Coloring Master</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #f0f4f8;
            font-family: "Varela Round", sans-serif; /* åœ“æ½¤å­—é«”é©åˆå…’ç«¥ */
            display: flex;
            flex-direction: column;
            height: 100vh;
            overscroll-behavior: none;
            user-select: none; /* ç¦æ­¢é¸å–æ–‡å­— */
        }

        /* é ‚éƒ¨æ§åˆ¶åˆ— (å¾©åŸ/é‡åš/å„²å­˜) */
        #toolbar {
            height: 60px;
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            z-index: 10;
        }

        .tool-group {
            display: flex;
            gap: 15px;
        }

        .btn {
            background: #eef2f5;
            border: none;
            border-radius: 12px;
            width: 44px;
            height: 44px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.1s;
        }

        .btn:active { transform: scale(0.9); background: #dce4e8; }
        
        /* ç¦ç”¨ç‹€æ…‹æ¨£å¼ */
        .btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            transform: none;
        }

        .btn-save { background: #4CD964; color: white; width: auto; padding: 0 20px; font-weight: bold; }

        /* ç•«å¸ƒå€åŸŸ */
        #canvas-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            background: #fff;
            margin: 10px;
            border-radius: 16px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.05); /* å…§é™°å½±å¢åŠ è³ªæ„Ÿ */
        }

        canvas {
            max-width: 100%;
            max-height: 100%;
            touch-action: none;
            cursor: crosshair;
        }

        /* åº•éƒ¨è‰²ç¥¨å€ */
        #palette {
            height: 90px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background: #fff;
            padding-bottom: env(safe-area-inset-bottom);
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.05);
        }

        .color-swatch {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: 3px solid #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* å½ˆæ€§å‹•ç•« */
        }
        .color-swatch.active { transform: scale(1.25); border-color: #333; z-index: 10; }
    </style>
</head>
<body>

    <div id="toolbar">
        <div class="tool-group">
            <button id="btn-undo" class="btn" title="å¾©åŸ">â†©ï¸</button>
            <button id="btn-redo" class="btn" title="é‡åš">â†ªï¸</button>
        </div>
        <button id="btn-save" class="btn btn-save" title="å„²å­˜åœ–ç‰‡">ğŸ’¾ å„²å­˜</button>
    </div>

    <div id="canvas-container">
        <canvas id="drawing-canvas"></canvas>
    </div>

    <div id="palette"></div>

    <script>
        // --- è¨­å®šèˆ‡åƒæ•¸ ---
        const IMAGE_FILENAME = 'coloring.png'; // âš ï¸ è«‹ç¢ºèªæ‚¨çš„æª”å
        const TOLERANCE = 50;  // å®¹å·®å€¼
        const MAX_HISTORY = 10; // æœ€å¤§å¾©åŸæ­¥æ•¸ (é¿å…è¨˜æ†¶é«”çˆ†æ‰)

        // --- DOM å…ƒç´  ---
        const canvas = document.getElementById('drawing-canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const paletteContainer = document.getElementById('palette');
        const btnUndo = document.getElementById('btn-undo');
        const btnRedo = document.getElementById('btn-redo');
        const btnSave = document.getElementById('btn-save');
        
        // --- ç‹€æ…‹è®Šæ•¸ ---
        let currentColor = [255, 59, 48, 255]; 
        const baseWidth = 800;
        const baseHeight = 800;
        
        // æ­·å²ç´€éŒ„å †ç–Š
        let historyStack = [];
        let redoStack = [];

        function init() {
            canvas.width = baseWidth;
            canvas.height = baseHeight;
            
            createPalette();
            loadLineArt();
            updateUI(); // åˆå§‹åŒ–æŒ‰éˆ•ç‹€æ…‹

            // äº‹ä»¶ç¶å®š
            canvas.addEventListener('pointerdown', handleCanvasClick);
            btnUndo.addEventListener('click', undo);
            btnRedo.addEventListener('click', redo);
            btnSave.addEventListener('click', saveImage);
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šç‹€æ…‹ç®¡ç† (Undo/Redo) ---
        
        // åœ¨ã€Œæ”¹è®Šç•«å¸ƒå‰ã€å‘¼å«æ­¤å‡½å¼ä¾†å­˜æª”
        function saveState() {
            // 1. å¦‚æœé‡åšå †ç–Šè£¡æœ‰æ±è¥¿ï¼Œæ¸…ç©ºå®ƒ (å› ç‚ºæœ‰äº†æ–°çš„åˆ†æ”¯)
            redoStack = []; 
            
            // 2. å„²å­˜ç•¶å‰å®Œæ•´åƒç´ æ•¸æ“š
            if (historyStack.length >= MAX_HISTORY) {
                historyStack.shift(); // ç§»é™¤æœ€èˆŠçš„ç´€éŒ„ï¼Œä¿æŒå †ç–Šå¤§å°
            }
            historyStack.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
            
            updateUI();
        }

        function undo() {
            if (historyStack.length === 0) return;

            // 1. æŠŠç¾åœ¨çš„ç‹€æ…‹å­˜å…¥ Redo å †ç–Š
            redoStack.push(ctx.getImageData(0, 0, canvas.width, canvas.height));

            // 2. å–å‡ºä¸Šä¸€æ­¥çš„ç‹€æ…‹
            const previousState = historyStack.pop();

            // 3. æ¢å¾©ç•«é¢
            ctx.putImageData(previousState, 0, 0);
            
            updateUI();
        }

        function redo() {
            if (redoStack.length === 0) return;

            // 1. æŠŠç¾åœ¨çš„ç‹€æ…‹å­˜å…¥ Undo å †ç–Š (ä»¥ä¾¿å†æ¬¡ Undo)
            historyStack.push(ctx.getImageData(0, 0, canvas.width, canvas.height));

            // 2. å–å‡ºæœªä¾†çš„ç‹€æ…‹
            const nextState = redoStack.pop();

            // 3. æ¢å¾©ç•«é¢
            ctx.putImageData(nextState, 0, 0);
            
            updateUI();
        }

        function updateUI() {
            // æ ¹æ“šå †ç–Šå…§å®¹æ±ºå®šæŒ‰éˆ•æ˜¯å¦å¯æŒ‰
            btnUndo.disabled = historyStack.length === 0;
            btnRedo.disabled = redoStack.length === 0;
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šå„²å­˜åœ–ç‰‡ ---
        function saveImage() {
            // å»ºç«‹ä¸€å€‹æš«æ™‚çš„é€£çµä¾†è§¸ç™¼ä¸‹è¼‰
            const link = document.createElement('a');
            // ä½¿ç”¨æ™‚é–“æˆ³è¨˜ç•¶æª”åï¼Œé¿å…é‡è¤‡
            const date = new Date();
            const timestamp = `${date.getFullYear()}${date.getMonth()+1}${date.getDate()}_${date.getHours()}${date.getMinutes()}`;
            
            link.download = `MyArt_${timestamp}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        // --- ç¹ªåœ–èˆ‡è¼‰å…¥é‚è¼¯ ---

        function loadLineArt() {
            const img = new Image();
            img.crossOrigin = "Anonymous";
            img.src = IMAGE_FILENAME;

            img.onload = function() {
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                const scale = Math.min(canvas.width / img.width, canvas.height / img.height);
                const w = img.width * scale;
                const h = img.height * scale;
                const x = (canvas.width - w) / 2;
                const y = (canvas.height - h) / 2;

                ctx.drawImage(img, x, y, w, h);
                // åœ–ç‰‡è¼‰å…¥å®Œæˆå¾Œï¼Œé€™å°±æ˜¯æˆ‘å€‘çš„ã€Œåˆå§‹ç‹€æ…‹ã€ï¼Œä½†ä¸ä¸€å®šè¦å­˜å…¥ Undoï¼Œ
                // é€™æ¨£ç”¨æˆ¶é» Undo å°±ä¸æœƒæŠŠåœ–ç‰‡è®Šä¸è¦‹ã€‚
            };
            
            img.onerror = function() {
                alert(`éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°åœ–ç‰‡ '${IMAGE_FILENAME}'`);
            };
        }

        function handleCanvasClick(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = Math.floor((e.clientX - rect.left) * scaleX);
            const y = Math.floor((e.clientY - rect.top) * scaleY);

            // åŸ·è¡Œå¡«è‰²
            floodFill(x, y, currentColor);
        }

        function floodFill(startX, startY, fillColor) {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const pixels = imageData.data;
            
            const startPos = (startY * canvas.width + startX) * 4;
            const startR = pixels[startPos];
            const startG = pixels[startPos + 1];
            const startB = pixels[startPos + 2];

            // æª¢æŸ¥æ˜¯å¦éœ€è¦å¡«è‰²
            if (colorsAreSimilar(startR, startG, startB, fillColor[0], fillColor[1], fillColor[2], 20) || 
                isBlackOutline(startR, startG, startB)) {
                return;
            }

            // âš ï¸ é—œéµå‹•ä½œï¼šåœ¨çœŸæ­£ä¿®æ”¹åƒç´ ä¹‹å‰ï¼Œå…ˆä¿å­˜ç•¶å‰ç‹€æ…‹ï¼
            saveState();
            // é€™è£¡æˆ‘å€‘éœ€è¦é‡æ–°ç²å– imageDataï¼Œå› ç‚º saveState å¯èƒ½é‚„æ²’åŸ·è¡Œå®Œå—ï¼Ÿ
            // å…¶å¯¦ä¸ç”¨ï¼Œå› ç‚º getImageData æ˜¯åŒæ­¥çš„ã€‚ä½†ç‚ºäº†é‚è¼¯ä¹¾æ·¨ï¼Œæˆ‘å€‘ç¹¼çºŒåŸ·è¡Œã€‚

            const queue = [[startX, startY]];
            const visited = new Uint8Array(canvas.width * canvas.height); 
            
            while (queue.length > 0) {
                const [x, y] = queue.shift();
                const pixelIndex = y * canvas.width + x;
                
                if (visited[pixelIndex]) continue;
                visited[pixelIndex] = 1;

                const pixelPos = pixelIndex * 4;
                const r = pixels[pixelPos];
                const g = pixels[pixelPos + 1];
                const b = pixels[pixelPos + 2];

                if (colorsAreSimilar(r, g, b, startR, startG, startB, TOLERANCE)) {
                    pixels[pixelPos] = fillColor[0];
                    pixels[pixelPos + 1] = fillColor[1];
                    pixels[pixelPos + 2] = fillColor[2];
                    pixels[pixelPos + 3] = 255; 

                    if (x > 0) queue.push([x - 1, y]);
                    if (x < canvas.width - 1) queue.push([x + 1, y]);
                    if (y > 0) queue.push([x, y - 1]);
                    if (y < canvas.height - 1) queue.push([x, y + 1]);
                }
            }

            ctx.putImageData(imageData, 0, 0);
        }

        function colorsAreSimilar(r1, g1, b1, r2, g2, b2, tol) {
            return (Math.abs(r1 - r2) + Math.abs(g1 - g2) + Math.abs(b1 - b2)) <= tol;
        }

        function isBlackOutline(r, g, b) {
            return r < 100 && g < 100 && b < 100; 
        }

        function createPalette() {
            const colors = [
                [255, 59, 48], [255, 149, 0], [255, 204, 0], [76, 217, 100],
                [90, 200, 250], [0, 122, 255], [88, 86, 214], [255, 105, 180], 
                [100, 100, 100], [255, 255, 255]
            ];
            colors.forEach((c, index) => {
                const div = document.createElement('div');
                div.className = `color-swatch ${index === 0 ? 'active' : ''}`;
                div.style.backgroundColor = `rgb(${c[0]},${c[1]},${c[2]})`;
                div.addEventListener('click', () => {
                    document.querySelectorAll('.color-swatch').forEach(el => el.classList.remove('active'));
                    div.classList.add('active');
                    currentColor = [...c, 255];
                });
                paletteContainer.appendChild(div);
            });
        }

        init();
    </script>
</body>
</html>
